<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">


<dom-module id="credit-card">
    <template>
        <style>
            :host {
                display: block;
            }

            .container {
                border: 2px solid #757575;
                padding: 20px;
            }
        </style>

        <firebase-auth user="{{user}}"></firebase-auth>
        <firebase-query
            id="query"
            path="/users/[[user.uid]]/twilioNumber"
            data="{{twilioNumber}}">
        </firebase-query>

        <h2>credit card</h2>

        <form id="creditCard" method="POST" action="/profile/[[user.uid]]/charge">
            <fieldset name="personalInfo">
                <label for="email">Email</label>
                <input type="email" id="email" value="[[user.email]]" placeholder="email@site.com">
            </fieldset>

            <fieldset name="cardInfo">
                <label for="cardNum" required>Card Number</label>
                <input type="tel" id="cardNum" placeholder="0000 0000 0000 0000">

                <label for="cardExp" required>Expires</label>
                <input type="tel" id="cardExp" placeholder="MM/YY">

                <label for="cardCVC" required>CVC</label>
                <input type="tel" id="cardCVC" placeholder="***">
            </fieldset>

            <input type="hidden" id="stripeToken" name="stripeToken">

            <paper-button on-tap="stripeHandler">Charge {{amount}}</paper-button>
        </form>

    </template>

    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery.payment/1.2.1/jquery.payment.min.js'></script>

    <script>
        Polymer({
            is: 'credit-card',

            properties: {
            },

            ready: function() {
                var cardNum = this.$.cardNum,
                    cardExp = this.$.cardExp,
                    cardCVC = this.$.cardCVC,
                    creditCard = this.$.creditCard,
                    $cardNum = jQuery(cardNum),
                    $cardExp = jQuery(cardExp),
                    $cardCVC = jQuery(cardCVC),
                    $creditCard = jQuery(creditCard);

                /* Format input fields using jQuery lib */
                $cardNum.payment('formatCardNumber');
                $cardExp.payment('formatCardExpiry');
                $cardCVC.payment('formatCardCVC');

                /* Card validation on form submit */
                $creditCard.submit(function(e){
                    var cardExpiryVal = $cardExp.payment('cardExpiryVal'),
                    cardType = jQuery.payment.cardType($cardNum.val()),
                    isValidNum = jQuery.payment.validateCardNumber($cardNum.val()),
                    isValidExp = jQuery.payment.validateCardExpiry(cardExpiryVal),
                    isValidCVC = jQuery.payment.validateCardCVC($cardCVC.val(), cardType);

                    if(isValidNum && isValidExp && isValidCVC) {
                        console.log('Credit Card validation successful!');
                    } else {
                        console.log('Failed to validate Credit Card');
                    }
                });
            },

            stripeHandler: function() {
                var handler = StripeCheckout.configure({
                    key: "pk_test_EWFz9MTb5qG8TyFpIp2016II",
                    token: function(token) {
                        this.$.stripeToken.val(token.id);
                        console.log(token.id);
                        this.$.creditCard.submit();
                    }
                });

                handler.open({
                    name: "Tribeyo",
                    description: "Purchase Number for $2",
                    amount: 200,
                    currency: "usd",
                    email: this.$.email.value
                });
                e.preventDefault();

                $(window).on('popstate', function() {
                    handler.close();
                });
            }

        });
    </script>
</dom-module>
