<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/stripe-payment-form/stripe-payment-form.html">
<link rel="import" href="stripe-charge.html">
<link rel="import" href="credit-card.html">

<dom-module id="twilio-purchase">
    <template>
        <style>
            :host {
                display: block;
            }

            .container {
                border: 2px solid #757575;
                padding: 20px;
            }

            .twilioInput {
                max-width: 25px;
            }

            .loader {
                position: fixed;
                z-index: 999;
                height: 2em;
                width: 2em;
                overflow: show;
                margin: auto;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }

            .red {
                color: #e64545;
            }

            h3 {
                margin-bottom:4px;
            }

            #backButton {
                display: none;
            }

            #stripeCharge {
                display: none;
            }

            #displayPurchase {
                display: none;
            }

            #submitButton {
                margin-top: 20px;
                background-color: #4285f4;
                color: white;
            }

            #cancelSubscription {
                background-color: #e64545;
                color: white;
            }
        </style>
        <style is="custom-style">
            paper-spinner.orange {
                --paper-spinner-color: var(--google-yellow-500);
            }
        </style>

        <firebase-auth user="{{user}}"></firebase-auth>
        <firebase-query
            id="query"
            path="/users/[[user.uid]]/twilio/number"
            data="{{twilioNumber}}">
        </firebase-query>

        <div id="displayPurchase" active="{{twilioResponse}}" class="container">
            <h3>Purchased Number: <span class="red">[[twilioResponse]]</span></h3>
            <h4>(forwards to: [[endpointPhoneNumber]])</h4>
            <paper-button id="cancelSubscription" on-tap="unsubscribe">Cancel Subscription</paper-button>
            <iron-ajax
                id="cancelSubscriptionPost"
                method="POST"
                url="/profile/[[user.uid]]/unsubscribe"
                on-response="_unsubscribeResponse">
            </iron-ajax>
        </div>


        <paper-spinner
            id="spinner"
            active="{{loading}}"
            class="orange loader">
        </paper-spinner>

        <div active="{{!twilioResponse}}" id="purchaseForm">
            <h3>Purchase a new number:</h3>

            <div class="container">

                <form id="twilioForm" is="iron-form" action="/profile/[[user.uid]]/newNumber" method="POST">

                    <iron-icon icon="maps:add-location"></iron-icon>
                    <span>What is the area code local to your area?</span>
                    <paper-input-container>
                        <label>Area Code</label>
                        <input name="areaCode" class="twilioInput" id="areaCode" is="iron-input" bind-value="{{areaCode::input}}" minlength="3" maxlength="3" required>
                    </paper-input-container>

                    <br>

                    <iron-icon icon="maps:local-phone"></iron-icon>
                    <span>This is the endpoint number that recieves redirected calls</span>
                    <paper-input-container>
                        <label>Redirect to:</label>
                        <input name="endpointPhoneNumber" class="twilioInput" id="endpointPhoneNumber" is="iron-input" bind-value="{{endpointPhoneNumber::input}}" minlength="10" maxlength="10" required>
                    </paper-input-container>

                    <paper-button id="submitButton" on-tap="stripeHandler">Pay with Card</paper-button>
                </form>

                <form id="creditCard" is="iron-form" action="/profile/[[user.uid]]/charge" method="POST">
                    <input type="hidden" id="email" is="iron-input" bind-value="{{email}}" value="[[user.email]]" name="email">
                    <input type="hidden" id="chargeAmount" is="iron-input" bind-value="{{chargeAmount::change}}" name="chargeAmount">
                    <input type="hidden" id="stripeToken" name="stripeToken" is="iron-input" bind-value="{{token::input}}">
                </form>

                <!-- <paper-button id="backButton" on-tap="backButton">< Edit Number Info</paper-button> -->

                <!-- <credit-card id="stripeCharge" amount="$2"></credit-card> -->

                <iron-ajax
                    id="stripePost"
                    handle-as="json"
                    headers='{"Content-Type": "application/json;charset=utf-8"}'
                    method="POST"
                    url="/profile/[[user.uid]]/charge"
                    loading="{{loading}}"
                    on-response="_stripeResponse">
                </iron-ajax>

                <iron-ajax
                    id="twilioPost"
                    handle-as="json"
                    headers='{"Content-Type": "application/json;charset=utf-8"}'
                    body="{{twilioBody}}"
                    method="POST"
                    url="/profile/[[user.uid]]/newNumber"
                    loading="{{loading}}"
                    on-response="_twilioResponse"
                    last-response="{{twilioResponse}}">
                </iron-ajax>

                <!-- <stripe-charge id="stripeCharge"></stripe-charge> -->

                <!-- <stripe-payment-form register-controller="/profile/[[user.uid]]/charge" mode="test" id="stripeCharge"></stripe-payment-form> -->
            </div>
        </div>

        <script>
        function phoneFormatter() {
            $('#endpointPhoneNumber').on('input', function() {
                var number = $(this).val().replace(/[^\d]/g, '');
                if(number.length == 10){
                    number = number.replace(/(\d{3})(\d{3})(\d{4})/, "($1) $2-$3");
                }
                $(this).val(number)
            });
        };

        $(phoneFormatter);
        </script>


    </template>

    <script>
        Polymer({
            is: 'twilio-purchase',

            properties: {
                twilioNumber: {
                    type: Object
                },
                active: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                areaCode: {
                    type: String,
                    notify: true
                },
                endpointPhoneNumber: {
                    type: String,
                    notify: true
                },
                chargeAmount: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true
                },
                token: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    value: 'auto'
                },
                stripeBody: {
                    type: String,
                    computed: 'processStripeBody(chargeAmount, token)'
                },
                twilioBody: {
                    type: String,
                    computed: 'processTwilioBody(areaCode, endpointPhoneNumber)'
                },
                loading: {
                    type: Boolean,
                    notify: true
                },
                twilioResponse: {
                    type: Object
                }
            },

            behaviors: [Polymer.PaperSpinnerBehavior],

            backButton: function() {
                this.$.twilioForm.style.display = "block";
                this.$.backButton.style.display = "none";
                this.$.stripeCharge.style.display = "none";
            },

            newNumber: function() {
                this.$.query.ref.set({
                    areaCode: this.$.areaCode.value,
                    endpointPhoneNumber: this.$.endpointNumber.value,
                    purchasedNumber: 'none'
                });
            },

            processStripeBody: function(chargeAmount, token) {
                console.log('processStripeBody called: ' + chargeAmount, token);
                return JSON.stringify({"chargeAmount": chargeAmount, "token": token});
            },

            processTwilioBody: function(areaCode, endpointPhoneNumber) {
                console.log('processTwilioBody called');
                return JSON.stringify({"areaCode": areaCode, "endpointPhoneNumber": endpointPhoneNumber});
            },

            showStripe: function() {
                this.$.twilioForm.style.display = "none";
                this.$.backButton.style.display = "inline-block";
                this.$.stripeCharge.style.display = "block";
            },

            stripeHandler: function() {
                var stripeToken = this.$.stripeToken,
                    creditCard = this.$.creditCard,
                    stripePost = this.$.stripePost;

                this.$.spinner.active = true;

                var handler = StripeCheckout.configure({
                    key: "pk_test_EWFz9MTb5qG8TyFpIp2016II",
                    token: function(token) {
                        stripePost.body = JSON.stringify({"token":token.id});
                        stripePost.generateRequest();
                    }
                });

                handler.open({
                    name: "Tribeyo",
                    description: "Purchase Number for $2",
                    amount: 200,
                    currency: "usd",
                    email: this.$.email.value
                });

                $(window).on('popstate', function() {
                    handler.close();
                });
            },

            unsubscribe: function() {
                this.$.cancelSubscriptionPost.generateRequest();
            },

            _stripeResponse: function(data) {
                var res = data.detail.response,
                    twilioPost = this.$.twilioPost,
                    query = this.$.query,
                    areaCode = this.$.areaCode.value,
                    endNumber = this.$.endpointPhoneNumber.value;

                if(res.payment === true) {
                    query.ref.set({
                        areaCode: areaCode,
                        endpointPhoneNumber: endNumber,
                        purchasedNumber: 'none'
                    });
                    twilioPost.generateRequest();
                }
            },

            _twilioResponse: function(data) {
                var res = data.detail.response;
                this.$.purchaseForm.style.display = 'none';
                this.$.displayPurchase.style.display = "inline-block";
                console.log(res);
            },

            _unsubscribeResponse: function(data) {
                var res = data.detail.response;
                console.log(res);
            }

        });
    </script>
</dom-module>
