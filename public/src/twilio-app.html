<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/note-app-elements/na-elements.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="login-firebase.html">

<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
<!-- <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
<script src="https://www.gstatic.com/firebasejs/3.7.1/firebase.js"></script> -->
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyD7k9zrxj_wzNne84J1DyimMrWF9lzbV6A",
        authDomain: "twilio-app-7c723.firebaseapp.com",
        databaseURL: "https://twilio-app-7c723.firebaseio.com",
        storageBucket: "twilio-app-7c723.appspot.com",
        messagingSenderId: "230550085450"
    };

    firebase.initializeApp(config);
</script>


<dom-module id="twilio-app">
    <template>
        <style>
            :host {
                --app-primary-color: #e64545;
                /*--app-secondary-color: #8ad4db;*/
                --app-secondary-color: #90cfd5;
                --app-alt-color: #404548;
                --app-neutral-color: #f2f2f2;

                display: block;
            }

            app-header {
                color: white;
                background-color: var(--app-alt-color);
            }
            app-header paper-icon-button {
                --paper-icon-button-ink-color: white;
            }

            #mark {
                width: 50px;
                margin-top: 0px;
                margin-left: 4px;
            }

            paper-dropdown-menu {
                width: 250px;
                height: auto;
                margin: auto;
                display: block;
            }

            a {
                text-decoration: none;
                color: inherit;
            }
            a:visited {
                color: inherit;
            }

            .drawer-list {
                margin: 0 20px;
            }

            .drawer-list a {
                display: block;
                padding: 0 16px;
                text-decoration: none;
                color: var(--app-alt-color);
                line-height: 40px;
                outline: none;
            }

            .drawer-list a.iron-selected {
                font-weight: bold;
                color: var(--app-primary-color);
            }

            .header-right {
                float: right;
                cursor: pointer;
                color: var(--app-neutral-color);
            }

            .login-icon {
                margin-right: 4px;
            }
            .menu-icon {
                margin-right: 4px;
                margin-bottom: 6px;
            }

            .card-view {
                max-width: 850px;
                margin: auto;
                box-shadow: none !important;
            }

        </style>

        <firebase-app
            name="twilio-app"
            api-key="AIzaSyD7k9zrxj_wzNne84J1DyimMrWF9lzbV6A"
            auth-domain="twilio-app-7c723.firebaseapp.com"
            database-url="https://twilio-app-7c723.firebaseio.com">
        </firebase-app>

        <firebase-auth
            id="auth"
            signed-in="{{signedIn}}"
            user="{{user}}">
        </firebase-auth>

        <app-location
            route="{{route}}"
            use-hash-as-path>
        </app-location>
        <app-route
            route="{{route}}"
            pattern="/:page"
            data="{{routeData}}"
            tail="{{routeTail}}">
        </app-route>

        <app-drawer-layout fullbleed>
            <!-- Drawer content -->
            <app-drawer id="drawer">
                <app-toolbar>Menu</app-toolbar>
                <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
                    <a name="home-view" href="#/home-view">
                        <iron-icon
                        class="menu-icon" icon="icons:home"></iron-icon>
                        Home</a>
                    <a name="subscription-plans" href="#/subscription-plans">
                        <iron-icon
                        class="menu-icon" icon="icons:dns"></iron-icon>
                        Subscription Plans</a>
                    <a name="sign-up" href="#/sign-up">
                        <iron-icon
                        class="menu-icon" icon="icons:add-circle"></iron-icon>
                        Sign Up</a>
                    <a name="profile-view" href="#/profile-view/[[user.uid]]">
                        <iron-icon
                        class="menu-icon" icon="icons:account-circle"></iron-icon>
                        Profile</a>
                </iron-selector>
            </app-drawer>

            <!-- Main content -->
            <app-header-layout has-scrolling-region>

                <app-header condenses reveals effects="waterfall">
                    <app-toolbar>
                        <paper-icon-button icon="my-icons:menu" drawer-toggle></paper-icon-button>
                        <div main-title>
                            <a href="#/home-view">
                                <img id="mark" src="../images/tribeyo_mark_white.png"/></a>
                        </div>
                        <div class="header-right">
                            <a hidden$="[[user]]" href="#/profile-view/">
                                <paper-button>
                                    <iron-icon
                                        class="login-icon" icon="icons:account-circle">
                                    </iron-icon> Login
                                </paper-button>
                            </a>
                            <paper-button
                                hidden$="[[!user]]" on-tap="logout">
                            Logout
                            </paper-button>
                        </div>
                    </app-toolbar>
                </app-header>

                <iron-pages
                    id="ironPages"
                    selected="[[page]]"
                    attr-for-selected="name"
                    fallback-selection="view404"
                    role="main">
                    <home-view class="card-view" user="{{user}}" name="home-view"></home-view>
                    <subscription-plans class="card-view" name="subscription-plans" route="{{routeTail}}"></subscription-plans>
                    <sign-up class="card-view" name="sign-up" route="{{routeTail}}"></sign-up>
                    <profile-view class="card-view" name="profile-view" route="{{routeTail}}"></profile-view>
                    <my-view404 class="card-view" name="my-view404"></my-view404>
                </iron-pages>
            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        Polymer({
            is: 'twilio-app',

            properties: {
                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged',
                }
            },

            behaviors: [Polymer.IronFormElementBehavior],

            logout: function() {
                if (this.$.auth) {
                    this.$.auth.signOut();
                    window.location.hash = '/home-view';
                }
            },

            observers: [
                '_routePageChanged(routeData.page)'
            ],

            _errorHandler: function() {
                console.log('error at <firebase-auth>');
            },

            _routePageChanged: function(page) {
                this.page = page || 'home-view';

                if (!this.$.drawer.persistent) {
                    this.$.drawer.close();
                }
            },

            _pageChanged: function(page) {
                // Load page import on demand. Show 404 page if fails
                var resolvedPageUrl = this.resolveUrl(page + '.html');
                this.importHref(resolvedPageUrl, null, this._showPage404, true);
            },

            _showPage404: function() {
                this.page = 'view404';
            }
        });

        firebase.auth().onAuthStateChanged(firebaseUser => {
            if(firebaseUser) {

                // window.location.hash = '/profile-view/' + firebaseUser.uid;

                firebaseUser.getToken(true).then(function(idToken) {

                    $.ajax({
                        type: 'POST',
                        url: '/profile/auth',
                        dataType: "json",
                        data: {idToken: idToken},
                        success: function(data)
                        {
                            //console.log('posted token: '); //JSON.stringify(data));
                        },
                        error: function(jqXHR, textStatus, errorThrown) {
                            console.log(textStatus + " " + errorThrown);
                        }
                    });

                }).catch(function(error) {
                    console.log('error at idToken: ' + error);
                });
            } else {
                console.log('twilio-app: not logged in');
            }
        });
    </script>
</dom-module>
