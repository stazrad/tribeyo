<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">

<dom-module id="sign-up-flow-2">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                outline: none;
            }

            .signUpForm {
                display: block;
                margin: auto;
                margin-top: 52px;
                width: 80%;
            }

            paper-input-container {
                height: 50px;
                display: inline-block;
                border-radius: 4px;
                border: 2px solid var(--app-neutral-color);
                margin: auto;
                /*margin-right: 12%;*/
                margin-top: 10px;
                margin-bottom: 14px;
                padding: 2px;
                width: 268px;
                --paper-input-container-color: var(--app-alt-color);
                --paper-input-container-focus-color: var(--app-alt-color);
                --paper-input-container-invalid-color: red;
                background: var(--app-neutral-color);
            }
            paper-input-container::shadow .underline {
                display: none !important;
            }
            #passwordContainer {
                margin-top: 0px;
                margin-bottom: 14px;
            }

            input {
                color: var(--app-alt-color) !important;
                font-weight: 800 !important;
                cursor: default;
            }

            .nameField {
                width: 125px;
            }
            .nameField:first-of-type {
                margin-right: 6px;
            }

            paper-button {
                color: white;
                background: var(--app-primary-color);
                margin: auto;
                margin-top: 10px;
                margin-bottom: 14px;
                display: block;
                width: 276px;
                height: 58px;
                font-size: 22px;
            }
            paper-button:hover {
                opacity: .8;
            }

            h3 {
                font-weight: 100;
                font-size: 35px;
                text-align: center;
                width: 100%;
                margin-top: 20px;
                margin-bottom: 20px;
                cursor: default;
            }

            iron-icon.inputIcon {
                color: var(--app-secondary-color);
                display: inline-block;
                margin-right: 4px;
                margin-bottom: 6px;
            }

            label {
                font-size: 18px;
                top: 4px !important;
                cursor: default;
            }
            .inputPadding {
                top: -8px !important;
            }

            paper-input-container:focus /deep/ label {
                top: 0px !important;
            }

        </style>


        <paper-element class="signUpForm" noink>
            <h3>Create a profile:</h3>
            <form is="iron-form" on-iron-form-response="responseHandler" id="createProfileForm" method="POST" action="/profile" autocomplete="on">

                <paper-input-container class="nameField" focused="{{focused1}}" always-float-label="[[focused1]]">
                    <label class="inputPadding"><iron-icon class="inputIcon" icon="icons:account-box"></iron-icon>First Name</label>
                    <input name="firstName" id="firstName" is="iron-input" required>
                </paper-input-container>
                <paper-input-container class="nameField" focused="{{focused2}}" always-float-label="[[focused2]]">
                    <label class="inputPadding"><iron-icon class="inputIcon" icon="icons:account-box"></iron-icon>Last Name</label>
                    <input name="lastName" id="lastName" is="iron-input" required>
                </paper-input-container>

                <br>

                <paper-input-container focused="{{focused3}}" always-float-label="[[focused3]]" hidden$="[[!signUpMethod]]">
                    <label class="inputPadding"><iron-icon class="inputIcon"
                    icon="icons:mail"></iron-icon>Email</label>
                    <input name="email" id="email" is="iron-input" type="email" required>
                </paper-input-container>

                <paper-input-container focused="{{focused5}}" always-float-label="[[focused5]]" hidden$="[[signUpMethod]]">
                    <label class="inputPadding"><iron-icon class="inputIcon" icon="communication:stay-current-portrait"></iron-icon>Phone Number</label>
                    <input name="phoneNumber" id="phoneNumber" is="iron-input" type="phoneNumber" required>
                </paper-input-container>

                <br>

                <paper-input-container focused="{{focused4}}" always-float-label="[[focused4]]" id="passwordContainer">
                    <label class="inputPadding"><iron-icon class="inputIcon" icon="icons:lock"></iron-icon>Password</label>
                    <input name="password" id="password" is="iron-input" minlength="6" type="password" required>
                </paper-input-container>

                <br>

                <input type="hidden" name="uid" id="uid" is="iron-input">

                <paper-button id="submitButtonEmail" on-tap="submitFormEmail" hidden$="[[!signUpMethod]]">Create Profile</paper-button>
                <paper-button id="submitButtonPhoneNumber" on-tap="submitFormPhoneNumber" hidden$="[[signUpMethod]]">Create Profile</paper-button>

            </form>
        </paper-element>

    </template>

    <script>

        var readyInput = {
            value: 0,
            lastElement: null
        };

        Polymer({
            is: 'sign-up-flow-2',

            behaviors: [
                Polymer.PaperButtonBehavior
            ],

            properties: {
                focused1: {
                    type: Boolean,
                    value: false,
                    observer: "_focused"
                },
                focused2: {
                    type: Boolean,
                    value: false,
                    observer: "_focused"
                },
                focused3: {
                    type: Boolean,
                    value: false,
                    observer: "_focused"
                },
                focused4: {
                    type: Boolean,
                    value: false,
                    observer: "_focused"
                },
                focused5: {
                    type: Boolean,
                    value: false,
                    observer: "_focused"
                },
                readyNext: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                signUpMethod: {
                    type: Boolean,
                    reflectToAttribute: true
                }
            },

            _focused: function(e) {

                if(readyInput.value > 4) {
                    if(e === true) {
                        var active = this.shadowRoot.activeElement;
                        if(active != null) {
                            var classList = active.previousElementSibling.classList;
                            classList.remove('inputPadding');
                            readyInput.lastElement = active;
                        }
                    } else if(e === false) {
                        var active = readyInput.lastElement;
                        if(active.value === '') {
                            var classList = active.previousElementSibling.classList;
                            classList.add('inputPadding');
                        }
                    };
                } else {
                    readyInput.value++;
                };
            },

            checkInput: function() {
                console.log(this.signUpMethod);
                this.signUpMethod = false;
                console.log(this.signUpMethod);
            },

            submitFormEmail: function(event) {
                var email = this.$.email.value;
                var password = this.$.password.value;
                var firstName = this.$.firstName.value;
                var lastName = this.$.lastName.value;
                var readyNext = this.readyNext;
                var form = Polymer.dom(event).localTarget.parentElement;
                this.readyNext = true;

                const promise = firebase.auth().createUserWithEmailAndPassword(email, password);
                promise.then(function(user) {

                    firebase.auth().currentUser.updateProfile({
                        displayName: firstName
                    }).catch(function(){
                        console.log('error at displayName');
                    });

                    function writeUserData() {

                        firebase.database().ref().child('users/'+user.uid).set({
                            uid: user.uid,
                            name: {
                                first: firstName,
                                last: lastName
                            },
                            email: email,
                            phoneNumber: 'none',
                            password: password,
                            twilio: {
                                number: {
                                    purchasedNumber: 'none'
                                }
                            },
                            stripe: {
                                id: 'none',
                                subscription: {
                                    id: 'none',
                                    plan: 'none',
                                    subscribed: false
                                }
                            }
                        });

                        // this.$.profilePost.body = JSON.stringify({'email': email, 'uid': user.uid});
                        // this.$.profilePost.generateRequest();

                        $.ajax({
                            type: 'POST',
                            url: '/profile',
                            dataType: "json",
                            data: {
                                email: email,
                                uid: user.uid,
                                firstName: firstName,
                                lastName: lastName
                            },
                            success: function(data)
                            {
                                console.log(this.readyNext); console.log(JSON.stringify(data));

                                this.readyNext = true;

                            }
                        });
                    };
                    writeUserData();
                });
            },

            submitFormPhoneNumber: function(event) {
                var phoneNumber = this.$.phoneNumber.value;
                var password = this.$.password.value;
                var firstName = this.$.firstName.value;
                var lastName = this.$.lastName.value;
                var form = Polymer.dom(event).localTarget.parentElement;

                const promise = firebase.auth().createUserWithEmailAndPassword(email, password);
                promise.then(function(user) {

                    firebase.auth().currentUser.updateProfile({
                        displayName: firstName
                    }).catch(function(){console.log('error at displayName');});

                    function writeUserData() {

                        firebase.database().ref().child('users/'+user.uid).set({
                            uid: user.uid,
                            name: {
                                first: firstName,
                                last: lastName
                            },
                            email: 'none',
                            phoneNumber: phoneNumber,
                            password: password,
                            twilio: {
                                number: {
                                    purchasedNumber: 'none'
                                }
                            },
                            stripe: {
                                id: 'none',
                                subscription: {
                                    id: 'none',
                                    plan: 'none',
                                    subscribed: false
                                }
                            }
                        });

                        // this.$.profilePost.body = JSON.stringify({'email': email, 'uid': user.uid});
                        // this.$.profilePost.generateRequest();
                        $.ajax({
                            type: 'POST',
                            url: '/profile',
                            dataType: "json",
                            data: {phoneNumber: phoneNumber, uid: user.uid, firstName: firstName, lastName: lastName},
                            success: function(data)
                            {
                                console.log('Profile POSTed '); console.log(JSON.stringify(data));
                                this.readyNext = true;
                            }
                        });
                    };
                    writeUserData();
                });
            },

            responseHandler: function(e) {
                console.log(e.detail.response);
            }
        });
    </script>
</dom-module>
